const PDF_READER_MAIN_URL=URL.createObjectURL(new Blob([`(${pdfjsLibWorker.toString()})()`])),PDF_WORKER_MAIN_URL=URL.createObjectURL(new Blob([`(${pdfWorkerJs.toString()})()`]));function PDFReader(e){"use strict";const t=[];let r,a=0;const s=[];let n,o=0,i=0,c=0;const l=(e,t,r,a=!0)=>{if(null!=r&&null!=r&&delete s[r],t.error)t.error.call(this,e);else{if(a)throw e;console.error(e.message)}},u=()=>`${(65536*(1+Math.random())|0).toString(32)}`+`-${(65536*(1+Math.random())|0).toString(32)}`+`-${(65536*(1+Math.random())|0).toString(32)}`+`-${(16777216*(1+Math.random())|0).toString(32)}`,g=()=>{++o>=Object.keys(t).length&&(o=0),n=Object.keys(t)[o]};var f=e=>r=>{const n=r.data,o=s[n.return];if(o){if(n.isPageNum){if("error"==n.type)return console.error(n.result),t[e].worker.terminate(),delete t[e],void(Object.keys(t).length<=0&&(l(new Error(n.result),o,n.return,!1),d.close()));a=n.result,t[e].initalized=!0;let r=!0;for(let e=0;e<t.length;e++)if(!t[e].initalized){r=!1;break}return void(r&&(c=Date.now(),o.success&&o.success.call(this,n.result),delete s[n.return]))}if(i++,"error"==n.type)return l(new Error(n.result),o,n.return);delete s[n.return],o.success&&o.success.call(this,n.result)}},p=()=>{const e=async e=>{for(let t=0;t<e.url.length;t++)importScripts(e.url[t]);try{e.data instanceof File?self.doc=await pdfjsLib.getDocument(await(e=>new Promise(t=>{const r=new FileReader;r.onloadend=(()=>{t(new Uint8Array(r.result))}),r.readAsArrayBuffer(e)}))(e.data)).promise:e.data instanceof Uint8Array?self.doc=await pdfjsLib.getDocument(e.data).promise:e.data instanceof Blob?self.doc=await pdfjsLib.getDocument(new Uint8Array(await e.data.ArrayBuffer())):"string"==typeof e.data&&(e.data.startsWith("data:")?self.doc=await pdfjsLib.getDocument((e=>{e.includes(",")&&(e=e.split(",")[1]);const t=atob(e),r=t.length,a=new Uint8Array(new ArrayBuffer(r));for(let e=0;e<r;e++)a[e]=t.charCodeAt(e);return a})(e.data)).promise:self.doc=await pdfjsLib.getDocument(e.data).promise),self.postMessage({type:"success",isPageNum:!0,result:self.doc.numPages,return:e.return})}catch(t){self.postMessage({type:"error",isPageNum:!0,result:t.message,return:e.return})}};self.addEventListener("message",t=>{const r=t.data;switch(r.type){case"init":e(r);break;case"getPageImage":self.doc?(async e=>{try{let t=e.scale;t||(t=96/72);const r=await self.doc.getPage(e.data),a=r.getViewport({scale:t}),s=new OffscreenCanvas(a.width,a.height);await r.render({canvasContext:s.getContext("2d",{alpha:!1}),viewport:a}).promise;const n={type:"success",result:await s.convertToBlob({type:"image/jpeg"}),return:e.return};e.toURL&&(n.result=URL.createObjectURL(n.result)),self.postMessage(n)}catch(t){self.postMessage({type:"error",result:t.message,return:e.return})}})(r):self.postMessage({type:"error",result:"PDF Document can't load",return:r.return});break;case"getImageBitMap":self.doc?(async e=>{try{let t=e.scale;t||(t=96/72);const r=await self.doc.getPage(e.data),a=r.getViewport({scale:t}),s=new OffscreenCanvas(a.width,a.height),n=s.getContext("2d",{alpha:!1});let o;await r.render({canvasContext:n,viewport:a}).promise;try{o=s.transferToImageBitmap()}catch{o=createImageBitmap(n.createImageData(s.width,s.height))}self.postMessage({type:"success",result:{bitmap:o,transform:{x:a.width,y:a.height}},return:e.return},[o])}catch(t){self.postMessage({type:"error",result:t.message,return:e.return})}})(r):self.postMessage({type:"error",result:"PDF Document can't load",return:r.return});break;case"drawPageCanvas":(async e=>{try{e.scale||(e.scale=96/72);const t=(await self.doc.getPage(e.page)).getViewport({scale:e.scale});e.data.width=t.width,e.data.height=t.height;const r=e.data.getContext("2d",{alpha:!1});r.fillStyle="aqua",r.fillRect(0,0,1e3,1e3),self.postMessage({type:"success",result:{x:t.width,y:t.height},return:e.return})}catch(t){self.postMessage({type:"error",result:t.message,return:e.return})}})(r)}})},d=new class{constructor(){if(void 0===e)throw new Error("Please input options data");if(!e.file)return l(new Error("Please input file"),e);const a=e.file;if(!(a instanceof File||a instanceof Blob||a instanceof Uint8Array||"string"==typeof a))throw new Error("file type must File or Blob or Uint8Array or string");(()=>{if(!(OffscreenCanvas&&Worker&&location.protocol.startsWith("http")))throw new Error("Can't Use");{r=URL.createObjectURL(new Blob([`(${p.toString()})()`]));let a=e.numWorkers;(!a||a<=0)&&(a=1);const n=u();s[n]=e;for(let s=0;s<a;s++){const a=new Worker(r);a.addEventListener("message",f(s)),a.postMessage({type:"init",data:e.file,url:[PDF_READER_MAIN_URL,PDF_WORKER_MAIN_URL],return:n}),t.push({worker:a})}g()}})()}getPageImage(e){if(t.length<=0)throw new Error("Can't use");if(!e.page)return l(new Error("Please input page"),e);const r=(()=>{let e=u();for(;s[e];)e=u();return e})();if(s[r]=e,void 0===e)throw new Error("Please input options data");t[n].worker.postMessage({type:"getPageImage",data:e.page,scale:e.scale,toURL:e.toURL,return:r}),g()}getImageBitMap(e){if(void 0===e)throw new Error("Please input options data");if(t.length<=0)return l(new Error("Can't use"),e);if(!e.page)return l(new Error("Please input page"),e);const r=(()=>{let e=u();for(;s[e];)e=u();return e})();s[r]=e,t[n].worker.postMessage({type:"getImageBitMap",data:e.page,scale:e.scale,return:r}),g()}drawPageCanvas(e){if(void 0===e)throw new Error("Please input options data");if(!e.page)return l(new Error("Please input page"),e);if(!e.canvas)return l(new Error("Please input canvas"),e);if(e.canvas instanceof HTMLCanvasElement){if(!e.canvas.transferControlToOffscreen)return l(new Error("Not support transferControlToOffscreen"),e);e.canvas=e.canvas.transferControlToOffscreen()}else if(!(e.canvas instanceof OffscreenCanvas))return l(new Error("Canvas should offScreenCanvas or canvas"),e);const r=(()=>{let e=u();for(;s[e];)e=u();return e})();if(s[r]=e,t.length<=0)return l(new Error("Can't use"),e);t[n].worker.postMessage({type:"drawPageCanvas",data:e.canvas,page:e.page,scale:e.scale,return:r},[e.canvas]),g()}get numPages(){return a}get numWorkers(){return t.length}get numImageConverts(){return i}get pdfLoadedTime(){return c}get isActive(){return t.length>0}close(){for(const e in t)t[e].worker.terminate();r&&URL.revokeObjectURL(r);for(const e in s)l(new Error("PDFReader closed"),s[e],!1)}};return d}
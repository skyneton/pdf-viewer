const PDF_READER_MAIN_URL=URL.createObjectURL(new Blob([`(${pdfjsLibWorker.toString()})()`])),PDF_WORKER_MAIN_URL=URL.createObjectURL(new Blob([`(${pdfWorkerJs.toString()})()`]));function PDFReader(e){"use strict";const t=[];let r,a=0;const s=[];let n,o=0,i=0,c=0;const l=(e,t,r,a=!0)=>{if(null!=r&&null!=r&&delete s[r],t.error)t.error.call(this,e);else{if(a)throw e;console.error(e.message)}},g=()=>`${(65536*(1+Math.random())|0).toString(32)}`+`-${(65536*(1+Math.random())|0).toString(32)}`+`-${(65536*(1+Math.random())|0).toString(32)}`+`-${(16777216*(1+Math.random())|0).toString(32)}`,u=()=>{++o>=Object.keys(t).length&&(o=0),n=Object.keys(t)[o]};var f=e=>r=>{const n=r.data,o=s[n.return];if(o){if(n.isPageNum){if("error"==n.type)return console.error(n.result),t[e].worker.terminate(),delete t[e],void(Object.keys(t).length<=0&&(l(new Error(n.result),o,n.return,!1),p.close()));a=n.result,t[e].initalized=!0;let r=!0;for(let e=0;e<t.length;e++)if(!t[e].initalized){r=!1;break}return void(r&&(c=Date.now(),o.success&&o.success.call(this,n.result),delete s[n.return]))}if(i++,"error"==n.type)return l(new Error(n.result),o,n.return);delete s[n.return],o.success&&o.success.call(this,n.result)}},d=()=>{const e=(e=1,t=1,r,a,s)=>{let n=1;if(0==e||0==t)return 1;if(r||a){let s=1;a<e&&(s=a/e);let o=1;r<t&&(o=r/t),n=Math.min(s,o)}if(s){const r=e*n*(t*n);r>s&&(n*=s/r)}return n},t=async e=>{for(let t=0;t<e.url.length;t++)importScripts(e.url[t]);try{e.data instanceof File?self.doc=await pdfjsLib.getDocument(await(e=>new Promise(t=>{const r=new FileReader;r.onloadend=(()=>{t(new Uint8Array(r.result))}),r.readAsArrayBuffer(e)}))(e.data)).promise:e.data instanceof Uint8Array?self.doc=await pdfjsLib.getDocument(e.data).promise:e.data instanceof Blob?self.doc=await pdfjsLib.getDocument(new Uint8Array(await e.data.ArrayBuffer())):"string"==typeof e.data&&(e.data.startsWith("data:")?self.doc=await pdfjsLib.getDocument((e=>{e.includes(",")&&(e=e.split(",")[1]);const t=atob(e),r=t.length,a=new Uint8Array(new ArrayBuffer(r));for(let e=0;e<r;e++)a[e]=t.charCodeAt(e);return a})(e.data)).promise:self.doc=await pdfjsLib.getDocument(e.data).promise),self.postMessage({type:"success",isPageNum:!0,result:self.doc.numPages,return:e.return})}catch(t){self.postMessage({type:"error",isPageNum:!0,result:t.message,return:e.return})}};self.addEventListener("message",r=>{const a=r.data;switch(a.type){case"init":t(a);break;case"getPageImage":self.doc?(async t=>{try{t.scale||(t.scale=96/72);const r=await self.doc.getPage(t.data);let a=r.getViewport({scale:t.scale});const s=e(a.width,a.height,t.maxHeight,t.maxWidth,t.maxPixels);1!=s&&(a=r.getViewport({scale:t.scale*s}));const n=new OffscreenCanvas(a.width,a.height);await r.render({canvasContext:n.getContext("2d",{alpha:!1}),viewport:a}).promise;const o={type:"success",result:await n.convertToBlob({type:"image/jpeg"}),return:t.return};t.toURL&&(o.result=URL.createObjectURL(o.result)),self.postMessage(o)}catch(e){self.postMessage({type:"error",result:e.message,return:t.return})}})(a):self.postMessage({type:"error",result:"PDF Document can't load",return:a.return});break;case"getImageBitMap":self.doc?(async t=>{try{t.scale||(t.scale=96/72);const r=await self.doc.getPage(t.data);let a=r.getViewport({scale:t.scale});const s=e(a.width,a.height,t.maxHeight,t.maxWidth,t.maxPixels);1!=s&&(a=r.getViewport({scale:t.scale*s}));const n=new OffscreenCanvas(a.width,a.height),o=n.getContext("2d",{alpha:!1});let i;await r.render({canvasContext:o,viewport:a}).promise;try{i=n.transferToImageBitmap()}catch{i=createImageBitmap(o.createImageData(n.width,n.height))}self.postMessage({type:"success",result:{bitmap:i,transform:{x:a.width,y:a.height}},return:t.return},[i])}catch(e){self.postMessage({type:"error",result:e.message,return:t.return})}})(a):self.postMessage({type:"error",result:"PDF Document can't load",return:a.return});break;case"drawPageCanvas":(async t=>{try{t.scale||(t.scale=96/72);const r=await self.doc.getPage(t.page);let a=r.getViewport({scale:t.scale});const s=e(a.width,a.height,t.maxHeight,t.maxWidth,t.maxPixels);1!=s&&(a=r.getViewport({scale:t.scale*s})),t.data.width=a.width,t.data.height=a.height;const n=t.data.getContext("2d",{alpha:!1});await r.render({canvasContext:n,viewport:a}).promise,self.postMessage({type:"success",result:{x:a.width,y:a.height},return:t.return})}catch(e){self.postMessage({type:"error",result:e.message,return:t.return})}})(a)}})},p=new class{constructor(){if(void 0===e)throw new Error("Please input options data");if(!e.file)return l(new Error("Please input file"),e);const a=e.file;if(!(a instanceof File||a instanceof Blob||a instanceof Uint8Array||"string"==typeof a))throw new Error("file type must File or Blob or Uint8Array or string");(()=>{if(!(OffscreenCanvas&&Worker&&location.protocol.startsWith("http")))throw new Error("Can't Use");{r=URL.createObjectURL(new Blob([`(${d.toString()})()`]));let a=e.numWorkers;(!a||a<=0)&&(a=1);const n=g();s[n]=e;for(let s=0;s<a;s++){const a=new Worker(r);a.addEventListener("message",f(s)),a.postMessage({type:"init",data:e.file,url:[PDF_READER_MAIN_URL,PDF_WORKER_MAIN_URL],return:n}),t.push({worker:a})}u()}})()}getPageImage(e){if(t.length<=0)throw new Error("Can't use");if(!e.page)return l(new Error("Please input page"),e);const r=(()=>{let e=g();for(;s[e];)e=g();return e})();if(s[r]=e,void 0===e)throw new Error("Please input options data");t[n].worker.postMessage({type:"getPageImage",data:e.page,scale:e.scale,toURL:e.toURL,maxWidth:e.maxWidth,maxHeight:e.maxHeight,maxPixels:e.pixels,return:r}),u()}getImageBitMap(e){if(void 0===e)throw new Error("Please input options data");if(t.length<=0)return l(new Error("Can't use"),e);if(!e.page)return l(new Error("Please input page"),e);const r=(()=>{let e=g();for(;s[e];)e=g();return e})();s[r]=e,t[n].worker.postMessage({type:"getImageBitMap",data:e.page,scale:e.scale,maxWidth:e.maxWidth,maxHeight:e.maxHeight,maxPixels:e.pixels,return:r}),u()}drawPageCanvas(e){if(void 0===e)throw new Error("Please input options data");if(!e.page)return l(new Error("Please input page"),e);if(!e.canvas)return l(new Error("Please input canvas"),e);if(e.canvas instanceof HTMLCanvasElement){if(!e.canvas.transferControlToOffscreen)return l(new Error("Not support transferControlToOffscreen"),e);e.canvas=e.canvas.transferControlToOffscreen()}else if(!(e.canvas instanceof OffscreenCanvas))return l(new Error("Canvas should offScreenCanvas or canvas"),e);const r=(()=>{let e=g();for(;s[e];)e=g();return e})();if(s[r]=e,t.length<=0)return l(new Error("Can't use"),e);t[n].worker.postMessage({type:"drawPageCanvas",data:e.canvas,page:e.page,scale:e.scale,maxWidth:e.maxWidth,maxHeight:e.maxHeight,maxPixels:e.pixels,return:r},[e.canvas]),u()}get numPages(){return a}get numWorkers(){return t.length}get numImageConverts(){return i}get pdfLoadedTime(){return c}get isActive(){return t.length>0}close(){for(const e in t)t[e].worker.terminate();r&&URL.revokeObjectURL(r);for(const e in s)l(new Error("PDFReader closed"),s[e],!1)}};return p}